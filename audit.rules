## RHEL 9 İçin Gelişmiş Audit Kuralları
## QRadar SIEM Entegrasyonu için Optimize Edilmiş
## Daemon/Servis/Cron hariç, gerçek kullanıcı aktiviteleri loglanır

# Performans ve buffer ayarları
-D
-b 32768
-f 2
-r 200
-i

# Kimlik ve Yetkilendirme Değişiklikleri
-w /etc/passwd -p wa -k identity_changes
-w /etc/shadow -p wa -k credential_access
-w /etc/group -p wa -k identity_changes
-w /etc/gshadow -p wa -k credential_access
-w /etc/sudoers -p wa -k privilege_escalation
-w /etc/sudoers.d/ -p wa -k privilege_escalation
-w /etc/securetty -p wa -k privilege_escalation

# PAM ve Güvenlik Konfigürasyonları
-w /etc/pam.d/ -p wa -k authentication_config
-w /etc/security/ -p wa -k security_config
-w /etc/login.defs -p wa -k login_config
-w /etc/default/useradd -p wa -k user_management

# SSH Konfigürasyonları ve Anahtarlar
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/ssh/ssh_config -p wa -k ssh_config
-w /etc/ssh/ssh_host_* -p wa -k ssh_host_keys
-w /root/.ssh/ -p wa -k ssh_keys_root
-w /home/*/.ssh/ -p wa -k ssh_keys_users

# TÜM KULLANICI KOMUTLARI (daemon/servis/cron hariç)
# UID >= 1000 gerçek kullanıcılar, UID < 1000 sistem kullanıcıları
# auid!=unset (4294967295) oturum açmış kullanıcılar
-a always,exit -F arch=b64 -S execve -F auid>=1000 -F auid!=unset -k user_commands
-a always,exit -F arch=b32 -S execve -F auid>=1000 -F auid!=unset -k user_commands

# Root olarak çalıştırılan komutlar (gerçek kullanıcılar tarafından)
-a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -F auid!=unset -k root_commands
-a always,exit -F arch=b32 -S execve -F euid=0 -F auid>=1000 -F auid!=unset -k root_commands

# Sudo ve yetki yükseltme komutları
-w /usr/bin/sudo -p x -k privilege_escalation_sudo
-w /bin/su -p x -k privilege_escalation_su
-w /usr/bin/pkexec -p x -k privilege_escalation_pkexec
-w /usr/bin/doas -p x -k privilege_escalation_doas

# Kullanıcı oturum açma/kapama olayları
-w /var/run/faillock/ -p wa -k failed_logins
-w /var/log/lastlog -p wa -k login_records
-w /var/log/wtmp -p wa -k session_records
-w /var/log/btmp -p wa -k failed_login_records

# Ağ konfigürasyon değişiklikleri
-a always,exit -F arch=b64 -S sethostname,setdomainname -F auid>=1000 -F auid!=unset -k network_config_change
-a always,exit -F arch=b32 -S sethostname,setdomainname -F auid>=1000 -F auid!=unset -k network_config_change
-w /etc/hosts -p wa -k network_hosts
-w /etc/resolv.conf -p wa -k network_dns
-w /etc/hostname -p wa -k network_hostname
-w /etc/network/ -p wa -k network_config
-w /etc/netplan/ -p wa -k network_netplan
-w /etc/NetworkManager/ -p wa -k network_manager
-w /etc/sysconfig/network-scripts/ -p wa -k network_scripts

# Firewall konfigürasyonları
-w /etc/firewalld/ -p wa -k firewall_config
-w /etc/nftables/ -p wa -k nftables_config
-w /etc/iptables/ -p wa -k iptables_config

# Sistem kapatma/yeniden başlatma komutları
-w /sbin/shutdown -p x -k system_shutdown
-w /sbin/poweroff -p x -k system_poweroff
-w /sbin/reboot -p x -k system_reboot
-w /sbin/halt -p x -k system_halt
-w /usr/bin/systemctl -p x -k systemctl_commands

# Dosya izin ve sahiplik değişiklikleri (kullanıcılar tarafından)
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k file_permission_change
-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k file_permission_change
-a always,exit -F arch=b64 -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=unset -k file_ownership_change
-a always,exit -F arch=b32 -S chown,fchown,lchown,fchownat -F auid>=1000 -F auid!=unset -k file_ownership_change
-a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k file_attr_change
-a always,exit -F arch=b32 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k file_attr_change

# Kritik sistem dosyalarına erişim
-w /etc/fstab -p wa -k mount_config
-w /etc/exports -p wa -k nfs_exports
-w /etc/crypttab -p wa -k encryption_config

# Process ve memory işlemleri (kullanıcılar tarafından)
-a always,exit -F arch=b64 -S ptrace -F auid>=1000 -F auid!=unset -k process_trace
-a always,exit -F arch=b32 -S ptrace -F auid>=1000 -F auid!=unset -k process_trace
-a always,exit -F arch=b64 -S kill -F auid>=1000 -F auid!=unset -k process_kill
-a always,exit -F arch=b32 -S kill -F auid>=1000 -F auid!=unset -k process_kill

# Ağ araçları kullanımı (kullanıcılar tarafından)
-w /usr/bin/wget -p x -F auid>=1000 -F auid!=unset -k network_download
-w /usr/bin/curl -p x -F auid>=1000 -F auid!=unset -k network_transfer
-w /usr/bin/nc -p x -F auid>=1000 -F auid!=unset -k network_netcat
-w /usr/bin/ncat -p x -F auid>=1000 -F auid!=unset -k network_ncat
-w /usr/bin/netcat -p x -F auid>=1000 -F auid!=unset -k network_netcat
-w /usr/bin/socat -p x -F auid>=1000 -F auid!=unset -k network_socat
-w /usr/bin/nmap -p x -F auid>=1000 -F auid!=unset -k network_scanning
-w /usr/bin/tcpdump -p x -F auid>=1000 -F auid!=unset -k packet_capture
-w /usr/sbin/tcpdump -p x -F auid>=1000 -F auid!=unset -k packet_capture
-w /usr/bin/tshark -p x -F auid>=1000 -F auid!=unset -k packet_capture
-w /usr/bin/wireshark -p x -F auid>=1000 -F auid!=unset -k packet_capture

# Uzak erişim araçları (kullanıcılar tarafından)
-w /usr/bin/ssh -p x -F auid>=1000 -F auid!=unset -k remote_access_ssh
-w /usr/bin/scp -p x -F auid>=1000 -F auid!=unset -k remote_access_scp
-w /usr/bin/sftp -p x -F auid>=1000 -F auid!=unset -k remote_access_sftp
-w /usr/bin/rsync -p x -F auid>=1000 -F auid!=unset -k remote_access_rsync
-w /usr/bin/rcp -p x -F auid>=1000 -F auid!=unset -k remote_access_rcp
-w /usr/bin/telnet -p x -F auid>=1000 -F auid!=unset -k remote_access_telnet

# Sistem keşif komutları (kullanıcılar tarafından)
-w /usr/bin/whoami -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/id -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/w -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/who -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /bin/uname -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/hostnamectl -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/lscpu -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/lsblk -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/lspci -p x -F auid>=1000 -F auid!=unset -k system_discovery
-w /usr/bin/lsusb -p x -F auid>=1000 -F auid!=unset -k system_discovery

# Dosya arama ve listeleme (kullanıcılar tarafından)
-w /usr/bin/find -p x -F auid>=1000 -F auid!=unset -k file_search
-w /usr/bin/locate -p x -F auid>=1000 -F auid!=unset -k file_search
-w /usr/bin/updatedb -p x -F auid>=1000 -F auid!=unset -k file_indexing

# Paket yönetimi
-w /usr/bin/rpm -p x -k package_management_rpm
-w /usr/bin/yum -p x -k package_management_yum
-w /usr/bin/dnf -p x -k package_management_dnf
-w /usr/bin/zypper -p x -k package_management_zypper
-w /usr/bin/apt -p x -k package_management_apt
-w /usr/bin/apt-get -p x -k package_management_apt

# Cron işleri (sadece değişiklikler, çalışmaları değil)
-w /etc/cron.d/ -p wa -k scheduled_tasks_config
-w /etc/cron.daily/ -p wa -k scheduled_tasks_config
-w /etc/cron.hourly/ -p wa -k scheduled_tasks_config
-w /etc/cron.monthly/ -p wa -k scheduled_tasks_config
-w /etc/cron.weekly/ -p wa -k scheduled_tasks_config
-w /var/spool/cron/ -p wa -k user_crontabs
-w /etc/crontab -p wa -k system_crontab
-w /etc/anacrontab -p wa -k anacron_config

# Systemd servisleri (sadece değişiklikler)
-w /etc/systemd/system/ -p wa -k systemd_config
-w /usr/lib/systemd/system/ -p wa -k systemd_config
-w /lib/systemd/system/ -p wa -k systemd_config
-w /etc/systemd/user/ -p wa -k systemd_user_config

# Kernel modül işlemleri
-a always,exit -F arch=b64 -S init_module,finit_module,delete_module -F auid>=1000 -F auid!=unset -k kernel_module_load
-a always,exit -F arch=b32 -S init_module,finit_module,delete_module -F auid>=1000 -F auid!=unset -k kernel_module_load
-w /usr/sbin/insmod -p x -k kernel_module_tools
-w /usr/sbin/rmmod -p x -k kernel_module_tools
-w /usr/sbin/modprobe -p x -k kernel_module_tools
-w /usr/sbin/depmod -p x -k kernel_module_tools

# Log dosyası değişiklikleri
-w /var/log/messages -p wa -k log_modification
-w /var/log/secure -p wa -k log_modification
-w /var/log/auth.log -p wa -k log_modification
-w /var/log/syslog -p wa -k log_modification
-w /var/log/audit/ -p wa -k audit_log_modification

# Audit konfigürasyon ve araçları
-w /etc/audit/ -p wa -k audit_config_change
-w /etc/audisp/ -p wa -k audit_dispatcher_config
-w /usr/sbin/auditctl -p x -k audit_tools
-w /usr/sbin/auditd -p x -k audit_daemon
-w /usr/sbin/ausearch -p x -k audit_search
-w /usr/sbin/aureport -p x -k audit_report
-w /usr/sbin/autrace -p x -k audit_trace

# SELinux işlemleri
-w /etc/selinux/ -p wa -k selinux_config
-w /usr/sbin/semanage -p x -k selinux_management
-w /usr/sbin/setsebool -p x -k selinux_boolean
-w /usr/sbin/setenforce -p x -k selinux_enforcement
-w /usr/bin/chcon -p x -k selinux_context

# Dosya sistemi mount/umount işlemleri
-a always,exit -F arch=b64 -S mount,umount2 -F auid>=1000 -F auid!=unset -k filesystem_mount
-a always,exit -F arch=b32 -S mount,umount,umount2 -F auid>=1000 -F auid!=unset -k filesystem_mount

# Soket işlemleri (kullanıcılar tarafından)
-a always,exit -F arch=b64 -S socket,connect,accept,bind,listen -F auid>=1000 -F auid!=unset -k network_socket
-a always,exit -F arch=b32 -S socket,connect,accept,bind,listen -F auid>=1000 -F auid!=unset -k network_socket

# Time değişiklikleri
-a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -k time_change
-a always,exit -F arch=b32 -S adjtimex,settimeofday,clock_settime -k time_change
-w /etc/localtime -p wa -k timezone_change

# Kullanıcı ve grup yönetimi
-w /usr/sbin/useradd -p x -k user_management
-w /usr/sbin/usermod -p x -k user_management
-w /usr/sbin/userdel -p x -k user_management
-w /usr/sbin/groupadd -p x -k group_management
-w /usr/sbin/groupmod -p x -k group_management
-w /usr/sbin/groupdel -p x -k group_management
-w /usr/bin/passwd -p x -k password_change
-w /usr/bin/chage -p x -k password_policy

# Container ve virtualization
-w /usr/bin/docker -p x -F auid>=1000 -F auid!=unset -k container_management
-w /usr/bin/podman -p x -F auid>=1000 -F auid!=unset -k container_management
-w /usr/bin/kubectl -p x -F auid>=1000 -F auid!=unset -k kubernetes_management
-w /usr/bin/virsh -p x -F auid>=1000 -F auid!=unset -k virtualization_management

# Kritik binary'lerin değişimi
-w /bin/ -p wa -k binary_modification
-w /sbin/ -p wa -k binary_modification
-w /usr/bin/ -p wa -k binary_modification
-w /usr/sbin/ -p wa -k binary_modification
-w /usr/local/bin/ -p wa -k binary_modification
-w /usr/local/sbin/ -p wa -k binary_modification

# Library değişiklikleri
-w /lib/ -p wa -k library_modification
-w /lib64/ -p wa -k library_modification
-w /usr/lib/ -p wa -k library_modification
-w /usr/lib64/ -p wa -k library_modification

# Kernel parametreleri
-w /etc/sysctl.conf -p wa -k kernel_parameters
-w /etc/sysctl.d/ -p wa -k kernel_parameters

# GRUB boot loader
-w /boot/grub2/grub.cfg -p wa -k bootloader_config
-w /boot/grub2/grubenv -p wa -k bootloader_config
-w /etc/default/grub -p wa -k bootloader_config

# Kritik sistem araçlarının kullanımı
-w /usr/bin/gcc -p x -F auid>=1000 -F auid!=unset -k compiler_usage
-w /usr/bin/g++ -p x -F auid>=1000 -F auid!=unset -k compiler_usage
-w /usr/bin/ld -p x -F auid>=1000 -F auid!=unset -k linker_usage
-w /usr/bin/as -p x -F auid>=1000 -F auid!=unset -k assembler_usage
-w /usr/bin/gdb -p x -F auid>=1000 -F auid!=unset -k debugger_usage
-w /usr/bin/strace -p x -F auid>=1000 -F auid!=unset -k system_trace
-w /usr/bin/ltrace -p x -F auid>=1000 -F auid!=unset -k library_trace

# Dosya silme işlemleri (kritik dizinlerde)
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F dir=/etc -F auid>=1000 -F auid!=unset -k file_deletion_etc
-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F dir=/etc -F auid>=1000 -F auid!=unset -k file_deletion_etc
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F dir=/var -F auid>=1000 -F auid!=unset -k file_deletion_var
-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F dir=/var -F auid>=1000 -F auid!=unset -k file_deletion_var

# Başarısız dosya erişimleri (yetkisiz erişim denemeleri)
-a always,exit -F arch=b64 -S open,openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -k unauthorized_file_access
-a always,exit -F arch=b64 -S open,openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -k unauthorized_file_access
-a always,exit -F arch=b32 -S open,openat -F exit=-EACCES -F auid>=1000 -F auid!=unset -k unauthorized_file_access
-a always,exit -F arch=b32 -S open,openat -F exit=-EPERM -F auid>=1000 -F auid!=unset -k unauthorized_file_access

# Privilege escalation attempts
-a always,exit -F arch=b64 -S setuid,setgid,setreuid,setregid -F auid>=1000 -F auid!=unset -k privilege_change
-a always,exit -F arch=b32 -S setuid,setgid,setreuid,setregid,setuid32,setgid32,setreuid32,setregid32 -F auid>=1000 -F auid!=unset -k privilege_change

# Kuralların sonu - değiştirilemez
-e 2
